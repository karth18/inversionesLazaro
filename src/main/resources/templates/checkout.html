<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{master.html}">
<head>
    <meta charset="UTF-8"/>
    <title>Checkout - Envío y Pago</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <style>
        .summary-card {
            position: sticky;
            top: 20px; /* Ajusta según tu header */
        }
        .address-card {
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .address-card.selected {
            border-color: #0d6efd;
            border-width: 2px;
        }
        .address-card:hover {
            border-color: #adb5bd;
        }
        #addressListModal .list-group-item {
            cursor: pointer;
        }
        #addressListModal .list-group-item:hover {
            background-color: #f8f9fa;
        }
        /* Estilos para el generador de mensajes de regalo */
        #giftMessageGenerator {
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container py-5" layout:fragment="content">
    <h1 class="mb-4 text-center text-primary">Detalles de Envío y Pago</h1>

    <!-- Contenedor principal de dos columnas -->
    <div class="row g-4">

        <!-- Columna Izquierda: Dirección y Método de Envío -->
        <div class="col-lg-8">

            <!-- Sección de Dirección de Envío -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">1. Dirección de Entrega</h2>
                </div>
                <div class="card-body">
                    <!-- Mostrar dirección seleccionada o mensaje si no hay ninguna -->
                    <div id="selectedAddressDisplay">
                        <div th:if="${direccionSeleccionada != null}">
                            <p class="mb-1"><strong>Principal:</strong></p>
                            <p th:text="${direccionSeleccionada.calleAvenida} + ' ' + ${direccionSeleccionada.numeroCalle}"></p>
                            <p th:text="${direccionSeleccionada.distrito} + ', ' + ${direccionSeleccionada.provincia} + ', ' + ${direccionSeleccionada.departamento}"></p>
                            <small th:if="${direccionSeleccionada.dptoInterior}"
                                   th:text="'Detalles: ' + ${direccionSeleccionada.dptoInterior}"></small>
                        </div>
                        <div th:unless="${direccionSeleccionada != null}" class="alert alert-warning" role="alert">
                            No has seleccionado ninguna dirección de envío.
                        </div>
                    </div>

                    <!-- Botones para Cambiar o Agregar Dirección -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#changeAddressModal"
                                th:disabled="${direccionesUsuario == null or direccionesUsuario.isEmpty()}">
                            Cambiar Dirección
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#newAddressModal">
                            Agregar Nueva Dirección
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sección de Método de Envío -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">2. Método de Envío</h2>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="shippingMethod" id="deliveryRadio"
                               value="delivery" checked>
                        <label class="form-check-label" for="deliveryRadio">
                            Despacho a Domicilio (Costo: S/ <span id="deliveryCost">10.00</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="shippingMethod" id="pickupRadio"
                               value="pickup">
                        <label class="form-check-label" for="pickupRadio">
                            Retiro en Tienda (Gratis)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Resumen del Pedido -->
        <div class="col-lg-4">
            <div class="card shadow-sm summary-card">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Resumen de tu Pedido</h2>
                </div>
                <div class="card-body">
                    <!-- Lista simulada de productos (debería venir del backend) -->
                    <ul class="list-group list-group-flush mb-3">
                        <li th:each="item : ${itemsCarrito}"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <small th:text="${item.producto.nomPro}"></small><br>
                                <small class="text-muted" th:text="'Cant: ' + ${item.cantidad}"></small>
                            </div>
                            <span th:text="'S/ ' + ${#numbers.formatDecimal(item.producto.precio * item.cantidad, 1, 'POINT', 2, 'COMMA')}"></span>
                        </li>
                        <!-- Ejemplo estático si ${itemsCarrito} está vacío -->
                        <li th:if="${itemsCarrito == null or itemsCarrito.isEmpty()}"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <small>Producto Ejemplo</small><br>
                                <small class="text-muted">Cant: 1</small>
                            </div>
                            <span>S/ 100.00</span>
                        </li>
                    </ul>

                    <hr>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal Productos:</span>
                        <span id="summarySubtotal">S/ 100.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Costo de Envío:</span>
                        <span id="summaryShippingCost">S/ 10.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Descuentos:</span>
                        <span id="summaryDiscount" class="text-success">- S/ 0.00</span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between fw-bold h5">
                        <span>Total a Pagar:</span>
                        <span id="summaryTotal">S/ 110.00</span>
                    </div>

                    <!-- Botón Ir a Pagar (deshabilitado hasta validar dirección si es delivery) -->
                    <button id="goToPaymentBtn" class="btn btn-success w-100 mt-4" disabled>Ir a Pagar</button>
                    <small id="paymentValidationMsg" class="d-block text-danger text-center mt-2"
                           style="display: none !important;">
                        Selecciona o agrega una dirección para el envío.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Nueva Dirección -->
    <div class="modal fade" id="newAddressModal" tabindex="-1" aria-labelledby="newAddressModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newAddressModalLabel">Agregar Nueva Dirección de Envío</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario de Nueva Dirección (campos simplificados) -->
                    <form id="newAddressForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="departamento" class="form-label">Departamento</label>
                                <input type="text" class="form-control" id="departamento" required>
                            </div>
                            <div class="col-md-4">
                                <label for="provincia" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="provincia" required>
                            </div>
                            <div class="col-md-4">
                                <label for="distrito" class="form-label">Distrito</label>
                                <input type="text" class="form-control" id="distrito" required>
                            </div>
                            <div class="col-md-8">
                                <label for="calleAvenida" class="form-label">Avenida / Calle / Jirón</label>
                                <input type="text" class="form-control" id="calleAvenida" required>
                            </div>
                            <div class="col-md-4">
                                <label for="numeroCalle" class="form-label">Número</label>
                                <input type="text" class="form-control" id="numeroCalle" required>
                            </div>
                            <div class="col-12">
                                <label for="dptoInterior" class="form-label">Dpto./ Interior/ Piso/ Lote/ Bloque
                                    (Opcional)</label>
                                <input type="text" class="form-control" id="dptoInterior">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="esPrincipalNew">
                                    <label class="form-check-label" for="esPrincipalNew">
                                        Marcar como dirección principal
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewAddressBtn">Guardar Dirección</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Cambiar Dirección -->
    <div class="modal fade" id="changeAddressModal" tabindex="-1" aria-labelledby="changeAddressModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeAddressModalLabel">Selecciona una Dirección</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p th:if="${direccionesUsuario == null or direccionesUsuario.isEmpty()}">No tienes direcciones
                        guardadas.</p>
                    <div class="list-group" th:unless="${direccionesUsuario == null or direccionesUsuario.isEmpty()}">
                        <label th:each="dir : ${direccionesUsuario}" class="list-group-item list-group-item-action">
                            <input class="form-check-input me-2" type="radio" name="selectedAddressRadio"
                                   th:value="${dir.id}"
                                   th:checked="${direccionSeleccionada != null and dir.id == direccionSeleccionada.id}">
                            <strong>
                                <span th:if="${dir.esPrincipal}">(Principal) </span>
                                <span th:text="${dir.calleAvenida} + ' ' + ${dir.numeroCalle}"></span>
                            </strong><br>
                            <small th:text="${dir.distrito} + ', ' + ${dir.provincia} + ', ' + ${dir.departamento}"></small>
                            <small th:if="${dir.dptoInterior}" th:text="', ' + ${dir.dptoInterior}"></small>
                        </label>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#newAddressModal" data-bs-dismiss="modal">
                        Agregar Nueva Dirección
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="selectAddressBtn">Seleccionar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Datos del Modelo (simulados o del backend)
        const itemsCarrito = /*[[${itemsCarrito}]]*/ []; // Lista de ItemCarrito
        const direccionSeleccionada = /*[[${direccionSeleccionada}]]*/ null; // Objeto Direccion o null
        const direccionesUsuario = /*[[${direccionesUsuario}]]*/ []; // Lista de Direccion
        const deliveryCost = 10.0; // Costo de envío
        const apiKey = ""; // API Key de Gemini (vacía según directrices)

        document.addEventListener('DOMContentLoaded', function() {

            // Elementos del DOM - Resumen
            const summarySubtotalEl = document.getElementById('summarySubtotal');
            const summaryShippingCostEl = document.getElementById('summaryShippingCost');
            const summaryDiscountEl = document.getElementById('summaryDiscount'); // Asumimos 0 descuento por ahora
            const summaryTotalEl = document.getElementById('summaryTotal');
            const deliveryCostDisplay = document.getElementById('deliveryCost');

            // Elementos del DOM - Envío y Pago
            const deliveryRadio = document.getElementById('deliveryRadio');
            const pickupRadio = document.getElementById('pickupRadio');
            const goToPaymentBtn = document.getElementById('goToPaymentBtn');
            const paymentValidationMsg = document.getElementById('paymentValidationMsg');
            const selectedAddressDisplay = document.getElementById('selectedAddressDisplay');

            // Elementos del DOM - Modales de Dirección
            const newAddressModalEl = document.getElementById('newAddressModal');
            const changeAddressModalEl = document.getElementById('changeAddressModal');
            const saveNewAddressBtn = document.getElementById('saveNewAddressBtn');
            const selectAddressBtn = document.getElementById('selectAddressBtn');
            const newAddressForm = document.getElementById('newAddressForm');

            // Elementos del DOM - Gemini Gift Message
            const giftMessageTextarea = document.getElementById('giftMessage');
            const generateGiftMsgBtn = document.getElementById('generateGiftMsgBtn');
            const recipientInput = document.getElementById('giftRecipient');
            const occasionInput = document.getElementById('giftOccasion');
            const toneSelect = document.getElementById('giftTone');
            const geminiLoading = document.getElementById('geminiLoading');

            // Estado Actual
            let currentShippingMethod = 'delivery';
            let currentSelectedAddress = direccionSeleccionada; // Puede ser null

            // --- Funciones ---

            // Calcula el subtotal de productos
            function calculateSubtotal() {
                let subtotal = 0;
                 if (itemsCarrito && itemsCarrito.length > 0) {
                     itemsCarrito.forEach(item => {
                         subtotal += (item.producto.precio * item.cantidad);
                     });
                 } else {
                     // Simulación si no hay items del backend
                     subtotal = 100.0;
                 }
                return subtotal;
            }

             // Formatea a moneda
            function formatCurrency(value) {
                return `S/ ${value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            }

            // Actualiza el Resumen de Compra en la UI
            function updateSummary() {
                const subtotal = calculateSubtotal();
                const shippingCost = currentShippingMethod === 'delivery' ? deliveryCost : 0;
                const discount = 0; // Lógica de descuento pendiente
                const total = subtotal + shippingCost - discount;

                summarySubtotalEl.textContent = formatCurrency(subtotal);
                summaryShippingCostEl.textContent = formatCurrency(shippingCost);
                summaryDiscountEl.textContent = `- ${formatCurrency(discount)}`;
                summaryTotalEl.textContent = formatCurrency(total);

                deliveryCostDisplay.textContent = deliveryCost.toFixed(2); // Actualiza costo en el radio

                validatePaymentButton(); // Validar si se puede pagar
            }

            // Valida si el botón "Ir a Pagar" debe estar activo
            function validatePaymentButton() {
                if (currentShippingMethod === 'delivery' && !currentSelectedAddress) {
                    goToPaymentBtn.disabled = true;
                    paymentValidationMsg.style.display = 'block';
                } else {
                    goToPaymentBtn.disabled = false;
                    paymentValidationMsg.style.display = 'none';
                }
            }

             // Actualiza la UI de la dirección seleccionada
            function updateSelectedAddressUI(address) {
                 currentSelectedAddress = address;
                 if (address) {
                     selectedAddressDisplay.innerHTML = `
                         <p class="mb-1"><strong>${address.esPrincipal ? '(Principal)' : ''}</strong></p>
                         <p>${address.calleAvenida || ''} ${address.numeroCalle || ''}</p>
                         <p>${address.distrito || ''}, ${address.provincia || ''}, ${address.departamento || ''}</p>
                         ${address.dptoInterior ? `<small>Detalles: ${address.dptoInterior}</small>` : ''}
                     `;
                 } else {
                     selectedAddressDisplay.innerHTML = `<div class="alert alert-warning" role="alert">No has seleccionado ninguna dirección de envío.</div>`;
                 }
                 validatePaymentButton();
            }

            // --- Lógica de Gemini ---
            async function generateGiftMessage() {
                const recipient = recipientInput.value.trim();
                const occasion = occasionInput.value.trim();
                const tone = toneSelect.value;

                if (!recipient || !occasion) {
                    alert('Por favor, ingresa para quién es el regalo y la ocasión.');
                    return;
                }

                geminiLoading.style.display = 'block';
                generateGiftMsgBtn.disabled = true;

                const systemPrompt = `Eres un asistente experto en escribir mensajes de regalo breves (máximo 2-3 frases), creativos y emotivos. El usuario te dará el destinatario, la ocasión y el tono deseado. Genera solo el texto del mensaje, sin saludos ni despedidas adicionales.`;
                const userQuery = `Genera un mensaje de regalo ${tone} para ${recipient} por su ${occasion}.`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                 const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                         maxOutputTokens: 100, // Limita la longitud del mensaje
                         temperature: 0.7 // Un poco creativo
                     }
                 };

                 try {
                     // Implementa reintentos con backoff exponencial
                    let response;
                    let retries = 0;
                    const maxRetries = 3;
                    let delay = 1000; // 1 segundo inicial

                    while (retries < maxRetries) {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                             const result = await response.json();
                             const candidate = result.candidates?.[0];
                             if (candidate?.content?.parts?.[0]?.text) {
                                const generatedText = candidate.content.parts[0].text.trim();
                                giftMessageTextarea.value = generatedText; // Pone el mensaje en el textarea
                                break; // Sale del bucle si es exitoso
                             } else {
                                 console.error('Respuesta inesperada de Gemini:', result);
                                 giftMessageTextarea.value = "Hubo un error al generar el mensaje.";
                                 break;
                             }
                        } else if (response.status === 429 || response.status >= 500) {
                            // Error de throttling o servidor, reintentar
                            retries++;
                            if (retries >= maxRetries) {
                                console.error(`Error ${response.status} de Gemini después de ${maxRetries} intentos.`);
                                giftMessageTextarea.value = "El servicio está ocupado, intenta de nuevo más tarde.";
                                break;
                            }
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Duplica el retraso
                        } else {
                            // Otro tipo de error, no reintentar
                             console.error('Error al llamar a Gemini:', response.status, await response.text());
                             giftMessageTextarea.value = "Hubo un error al generar el mensaje.";
                             break;
                        }
                    }

                 } catch (error) {
                     console.error('Error de red o fetch:', error);
                     giftMessageTextarea.value = "Error de conexión al generar el mensaje.";
                 } finally {
                     geminiLoading.style.display = 'none';
                     generateGiftMsgBtn.disabled = false;
                 }
            }


            // --- Event Listeners ---

             // Cambiar Método de Envío
            deliveryRadio.addEventListener('change', () => {
                currentShippingMethod = 'delivery';
                updateSummary();
            });
            pickupRadio.addEventListener('change', () => {
                currentShippingMethod = 'pickup';
                updateSummary();
            });

            // Guardar Nueva Dirección (Simulado - Debería ser una llamada AJAX POST)
            saveNewAddressBtn.addEventListener('click', () => {
                // Aquí iría la lógica para enviar los datos del formulario #newAddressForm al backend
                // Por ahora, solo cerramos el modal y simulamos la actualización
                 const newAddressData = { // Simulación de datos
                     id: Math.floor(Math.random() * 1000), // ID Temporal
                     departamento: document.getElementById('departamento').value,
                     provincia: document.getElementById('provincia').value,
                     distrito: document.getElementById('distrito').value,
                     calleAvenida: document.getElementById('calleAvenida').value,
                     numeroCalle: document.getElementById('numeroCalle').value,
                     dptoInterior: document.getElementById('dptoInterior').value,
                     esPrincipal: document.getElementById('esPrincipalNew').checked
                 };

                 console.log("Guardando (simulado):", newAddressData);
                  // Lógica para añadir a la lista 'direccionesUsuario' y actualizar UI (PENDIENTE)
                 // updateSelectedAddressUI(newAddressData); // Selecciona la nueva dirección

                 const modal = bootstrap.Modal.getInstance(newAddressModalEl);
                 modal.hide();
                 newAddressForm.reset(); // Limpiar formulario
                 // Idealmente, recargar la lista de direcciones en el modal de cambio
            });

            // Seleccionar Dirección del Modal de Cambio
            selectAddressBtn.addEventListener('click', () => {
                const selectedRadio = changeAddressModalEl.querySelector('input[name="selectedAddressRadio"]:checked');
                if (selectedRadio) {
                    const selectedId = parseInt(selectedRadio.value, 10);
                    const selectedDir = direccionesUsuario.find(dir => dir.id === selectedId);
                    if (selectedDir) {
                        updateSelectedAddressUI(selectedDir);
                    }
                    const modal = bootstrap.Modal.getInstance(changeAddressModalEl);
                    modal.hide();
                } else {
                    alert("Por favor, selecciona una dirección.");
                }
            });

            // Botón Generar Mensaje de Regalo
            generateGiftMsgBtn.addEventListener('click', generateGiftMessage);


            // --- Inicialización ---
            updateSummary(); // Calcula y muestra los totales iniciales

        });
        /*]]>*/
    </script>
</div>
</body>
</html>