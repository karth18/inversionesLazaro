<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{master.html}">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${producto.id == null ? 'Registro de Producto' : 'Edición de Producto'}"></title>
    <style>
        .image-preview-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .image-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-item:hover {
            opacity: 0.8;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .badge {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #007bff;
            color: white;
            padding: 2px 5px;
            font-size: 0.75rem;
            border-radius: 0 0 5px 0;
            z-index: 10;
        }
        .image-item button {
            position: absolute;
            top: 0;
            right: 0;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 0 6px;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            z-index: 10;
            border-radius: 0 5px 0 5px;
        }
        .image-item .plus-sign {
            font-size: 3rem;
            color: #ccc;
        }
    </style>
</head>
<body>
<div class="container py-4" layout:fragment="content">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h1 class="card-title h4" th:text="${producto.id == null ? 'Registrar Nuevo Producto' : 'Editar Producto: ' + producto.nomPro}"></h1>
        </div>
        <div class="card-body">

            <div id="alertContainer"></div>
            <div th:if="${msgAdvertencia}" class="alert alert-warning" th:text="${msgAdvertencia}"></div>
            <div th:if="${msgError}" class="alert alert-danger" th:text="${msgError}"></div>

            <form id="productForm" th:action="@{/admin/productos/guardar}" th:object="${producto}">

                <input type="hidden" th:field="*{id}"/>
                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 h6">Datos Principales</legend>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="codPro" class="form-label">Código Producto</label>
                            <input type="text" th:field="*{codPro}" id="codPro" class="form-control"
                                   th:errorClass="is-invalid" required>
                            <div class="invalid-feedback"
                                   th:errors="*{codPro}"
                                   th:if="${#fields.hasErrors('codPro')}" > </div>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label for="nomPro" class="form-label">Nombre</label>
                            <input type="text" th:field="*{nomPro}" id="nomPro" class="form-control"
                                   th:errorClass="is-invalid" required>
                            <div class="invalid-feedback"
                                 th:errors="*{nomPro}"
                                 th:if="${#fields.hasErrors('nomPro')}" > </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="estado" th:field="*{estado}">
                                <label class="form-check-label" for="estado">Producto Activo (visible en la tienda)</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="precio" class="form-label">Precio Regular (S/)</label>
                            <input type="number" step="0.01" th:field="*{precio}" id="precio" class="form-control"
                                   th:errorClass="is-invalid" required>
                            <div class="invalid-feedback"
                                 th:errors="*{precio}"
                                 th:if="${#fields.hasErrors('precio')}" > </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="precioOferta" class="form-label">Precio Oferta (S/)</label>
                            <input type="number" step="0.01" th:field="*{precioOferta}" id="precioOferta" class="form-control"
                                   th:errorClass="is-invalid" required>
                            <div class="invalid-feedback"
                                 th:errors="*{precioOferta}"
                                 th:if="${#fields.hasErrors('precioOferta')}" > </div>
                            <small class="form-text text-muted">Dejar en 0 o vacío si no hay oferta.</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" th:field="*{stock}" id="stock" class="form-control"
                                   th:errorClass="is-invalid" required>
                            <div class="invalid-feedback"
                                 th:errors="*{stock}"
                                 th:if="${#fields.hasErrors('stock')}" > </div>
                        </div>
<!--                    codigo nuevo dias de procesamiento-->
                        <div class="col-md-3 mb-3">
                            <label for="diasProcesamiento" class="form-label text-primary fw-bold">Días Despacho</label>
                            <div class="input-group">
                                <input type="number" th:field="*{diasProcesamiento}" id="diasProcesamiento"
                                       class="form-control" th:errorClass="is-invalid" required min="0" value="0">
                                <span class="input-group-text">días</span>
                            </div>
                            <div class="invalid-feedback"
                                 th:errors="*{diasProcesamiento}"
                                 th:if="${#fields.hasErrors('diasProcesamiento')}"></div>
                            <small class="form-text text-muted" style="font-size: 0.75rem;">
                                0 = Sale hoy mismo.
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="descripcionCorta" class="form-label">Descripción Corta</label>
                        <textarea th:field="*{descripcionCorta}" id="descripcionCorta" class="form-control" rows="2"
                                  th:errorClass="is-invalid" required></textarea>
                        <div class="invalid-feedback"
                             th:errors="*{descripcionCorta}"
                             th:if="${#fields.hasErrors('descripcionCorta')}" > </div>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionLarga" class="form-label">Descripción Larga</label>
                        <textarea th:field="*{descripcionLarga}" id="descripcionLarga" class="form-control" rows="4"
                                  th:classappend="${#fields.hasErrors('descripcionLarga')} ? 'is-invalid' : ''"></textarea>
                        <div class="invalid-feedback" th:errors="*{descripcionLarga}"></div>
                    </div>
                </fieldset>

                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 h6">Categorización y Dimensiones</legend>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="idMarca" class="form-label">Marca</label>
                            <select th:field="*{idMarca}" id="idMarca" class="form-select"
                                    th:errorClass="is-invalid" required>
                                <option value="">Seleccione una Marca</option>
                                <option th:each="m : ${marcas}" th:value="${m.id}" th:text="${m.nombre}"></option>
                            </select>
                            <div class="invalid-feedback"
                                 th:errors="*{idMarca}"
                                 th:if="${#fields.hasErrors('idMarca')}" > </div>

                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="idCate" class="form-label">Categoría</label>
                            <select th:field="*{IdCate}" id="idCate" class="form-select"
                                    th:errorClass="is-invalid" required>
                                <option value="">Seleccione una Categoría</option>
                                <option th:each="c : ${categorias}" th:value="${c.id}" th:text="${c.nombre}"></option>
                            </select>
                            <div class="invalid-feedback"
                                 th:errors="*{IdCate}"
                                 th:if="${#fields.hasErrors('IdCate')}" > </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="idTipo" class="form-label">Tipo Producto</label>
                            <select th:field="*{idTipo}" id="idTipo" class="form-select"
                                    th:errorClass="is-invalid" required
                                    th:disabled="${producto.idTipo == null}">
                                <option th:if="${producto.idTipo == null}" value="">Seleccione una Categoría primero</option>
                                <option th:unless="${producto.idTipo == null}" th:each="t : ${tiposProducto}" th:value="${t.id}" th:text="${t.nombre}" th:selected="${t.id == producto.idTipo.id}"></option>
                            </select>
                            <div class="invalid-feedback"
                                 th:errors="*{idTipo}"
                                 th:if="${#fields.hasErrors('idTipo')}" > </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="altoCm" class="form-label">Alto (cm)</label>
                            <input type="number" step="0.1" th:field="*{altoCm}" id="altoCm" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="anchoCm" class="form-label">Ancho (cm)</label>
                            <input type="number" step="0.1" th:field="*{anchoCm}" id="anchoCm" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fondoCm" class="form-label">Fondo (cm)</label>
                            <input type="number" step="0.1" th:field="*{fondoCm}" id="fondoCm" class="form-control">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 h6">Especificaciones Técnicas</legend>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="modelo" class="form-label">Modelo</label>
                            <input type="text" th:field="*{modelo}" id="modelo" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="material" class="form-label">Material</label>
                            <input type="text" th:field="*{material}" id="material" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="paisOrigen" class="form-label">País de Origen</label>
                            <input type="text" th:field="*{paisOrigen}" id="paisOrigen" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="potenciaBtu" class="form-label">Potencia (BTU)</label>
                            <input type="number" th:field="*{potenciaBtu}" id="potenciaBtu" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="garantiaMeses" class="form-label">Garantía (Meses)</label>
                            <input type="number" th:field="*{garantiaMeses}" id="garantiaMeses" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="fichaTecnica" class="form-label">Ficha Técnica (Opcional)</label>
                        <textarea th:field="*{fichaTecnica}" id="fichaTecnica" class="form-control" rows="3"></textarea>
                        <small class="form-text text-muted">Ej: "Voltaje: 220V, Frecuencia: 60Hz"</small>
                    </div>
                </fieldset>


                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 h6">Imágenes del Producto (Máx. 10)</legend>

                    <input type="file" id="dynamicFileInput" class="d-none" name="archivosImagen" multiple accept="image/*">

                    <h6 class="mt-4">Imágenes Actuales y Nuevas:</h6>
                    <div id="imageManagerContainer" class="image-preview-container">

                        <div th:if="${producto.id != null and producto.imagenes != null}"
                             th:each="img, stat : ${producto.imagenes}"
                             th:id="'existing-image-' + ${img.id}"
                             class="image-item shadow-sm"
                             th:data-is-existing="true">
                            <img th:src="@{'/uploads/' + ${img.ruta}}" alt="Imagen">
                            <span th:if="${img.esPrincipal}" class="badge bg-success">Principal</span>
                            <button type="button" class="btn-remove btn btn-sm btn-danger remove-existing-file"
                                    th:data-id="${img.id}"
                                    title="Eliminar esta imagen. El cambio se guardará al enviar el formulario.">
                                &times;
                            </button>
                        </div>

                        <div id="addMoreImagesButton" class="image-item add-button">
                            <span class="plus-sign">+</span>
                        </div>

                    </div>
                    <small class="form-text text-muted mt-2">Haz clic en '+' para añadir nuevas imágenes. Máximo total: 10.</small>
                </fieldset>

                <div class="d-flex justify-content-between">
                    <a th:href="@{/admin/productos}" class="btn btn-secondary">Cancelar</a>
                    <button type="button" id="submitButton" class="btn btn-success" th:text="${producto.id == null ? 'Registrar Producto' : 'Guardar Cambios'}">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <script th:inline="javascript">
        /* <![CDATA[ */

        // --- Función para inicializar listeners y lógica del formulario ---
        function initializeProductForm() {
            console.log("Inicializando/Re-inicializando listeners del formulario..."); // Para depuración

            // --- Seleccionar Elementos ---
            const form = document.getElementById('productForm');
            const submitButton = document.getElementById('submitButton');
            const fileInput = document.getElementById('dynamicFileInput');
            const imageManagerContainer = document.getElementById('imageManagerContainer');
            const addMoreButton = document.getElementById('addMoreImagesButton');
            const alertContainer = document.getElementById('alertContainer');
            const selectCategoria = document.getElementById('idCate');
            const selectTipoProducto = document.getElementById('idTipo');

            // Salir si algún elemento esencial no se encuentra (puede pasar durante la recarga)
            if (!form || !submitButton || !fileInput || !imageManagerContainer || !addMoreButton || !selectCategoria || !selectTipoProducto) {
                console.warn("Advertencia: No se encontraron todos los elementos del formulario para inicializar.");
                return;
            }

            // --- Variables de Estado (Resetear en cada inicialización) ---
            let filesToUpload = new DataTransfer(); // IMPORTANTE: Resetear aquí
            const MAX_IMAGES = 10;
            const csrfParameterName = /*[[${_csrf?.parameterName}]]*/ null;
            const csrfToken = /*[[${_csrf?.token}]]*/ null;
            const initialTipoId = /*[[${producto.idTipo?.id}]]*/ null;

            // --- Funciones Auxiliares ---
            function showAlert(message, type = 'danger') {
                const container = document.getElementById('alertContainer'); // Re-seleccionar por si acaso
                if(container) {
                    container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                    setTimeout(() => { container.innerHTML = ''; }, 5000);
                }
            }
            function countTotalImages() {
                 const container = document.getElementById('imageManagerContainer'); // Re-seleccionar
                 return container ? container.querySelectorAll('.image-item:not(.add-button)').length : 0;
            }

            // --- Lógica Dropdowns Dependientes ---
            async function cargarTiposProducto(idCategoria) {
                 const currentSelectTipo = document.getElementById('idTipo'); // Re-seleccionar
                 if(!currentSelectTipo) return;
                 currentSelectTipo.innerHTML = '<option value="">Cargando...</option>';
                 currentSelectTipo.disabled = true;
                 // ... (resto de tu lógica fetch sin cambios) ...
                 if (!idCategoria) {
                     currentSelectTipo.innerHTML = '<option value="">Seleccione Categoría</option>';
                     return;
                 }
                 try {
                     const response = await fetch(`/admin/productos/api/tipos-por-categoria/${idCategoria}`);
                     if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                     const tipos = await response.json();
                     currentSelectTipo.innerHTML = '<option value="">Seleccione Tipo</option>';
                     currentSelectTipo.disabled = false;
                     tipos.forEach(tipo => {
                         const option = document.createElement('option');
                         option.value = tipo.id;
                         option.textContent = tipo.nombre;
                         if (initialTipoId && tipo.id == initialTipoId) option.selected = true;
                         currentSelectTipo.appendChild(option);
                     });
                     if (tipos.length === 0) {
                         currentSelectTipo.innerHTML = '<option value="">No hay Tipos</option>';
                         currentSelectTipo.disabled = true;
                     }
                 } catch (error) {
                     console.error("Error cargando Tipos:", error);
                     currentSelectTipo.innerHTML = '<option value="">Error</option>';
                     currentSelectTipo.disabled = true;
                 }
            }
            // *Adjuntar* listener (sin borrar explícitamente, el reemplazo del DOM lo hace)
            selectCategoria.addEventListener('change', function() {
                cargarTiposProducto(this.value);
            });

            // --- Lógica Gestión de Imágenes ---
             addMoreButton.addEventListener('click', function() {
                 if (countTotalImages() >= MAX_IMAGES) {
                     showAlert(`Máximo ${MAX_IMAGES} imágenes.`, 'warning');
                     return;
                 }
                 document.getElementById('dynamicFileInput').click(); // Re-seleccionar
             });

             fileInput.addEventListener('change', function(e) {
                 const files = e.target.files;

<!--                 filesToUpload = new DataTransfer();-->

                 for (let i = 0; i < files.length; i++) {
                     const file = files[i];
                     if (!file.type.startsWith('image/')) continue;
                     if (countTotalImages() < MAX_IMAGES) {
                         filesToUpload.items.add(file);
                         renderNewImagePreview(file);
                     } else {
                         showAlert(`Límite de ${MAX_IMAGES} alcanzado.`, 'warning');
                         break;
                     }
                 }
                 this.value = ''; // Limpiar input
             });

             function renderNewImagePreview(file) {
                 const reader = new FileReader();
                 const previewDiv = document.createElement('div');
                 previewDiv.className = 'image-item shadow-sm new-image';
                 previewDiv.dataset.filename = file.name + Date.now();
                 previewDiv.dataset.isNew = true;
                 const container = document.getElementById('imageManagerContainer');
                 const addButton = document.getElementById('addMoreImagesButton');

                 if(!container || !addButton) return; // Chequeo extra

                 reader.onload = function(e) {
                     previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Nueva">
                        <span class="badge bg-primary">Nueva</span>
                        <button type="button" class="btn-remove btn-sm btn-danger remove-new-file" data-temp-id="${previewDiv.dataset.filename}">&times;</button>
                     `;
                     container.insertBefore(previewDiv, addButton);
                 };
                 reader.readAsDataURL(file);
             }

             imageManagerContainer.addEventListener('click', function(e) {
                 if (e.target.classList.contains('remove-new-file')) {
                     const fileItem = e.target.closest('.new-image');
                     // TODO: Idealmente, también remover de 'filesToUpload' aquí.
                     // Por ahora, solo removemos del DOM. El submit usará lo que quede en filesToUpload.
                     if (fileItem) fileItem.remove();

                 } else if (e.target.classList.contains('remove-existing-file')) {
                      const fileItem = e.target.closest('.image-item');
                      // TODO: Necesitarías enviar al backend qué IDs existentes eliminar.
                      // Por ahora, solo lo quitamos visualmente.
                      if (fileItem) fileItem.remove();
                      showAlert("Imagen existente marcada para eliminar (requiere lógica backend).", 'warning');
                 }
             });

            // --- Lógica de Submit ---
            submitButton.addEventListener('click', async function(e) {
                e.preventDefault();
                this.disabled = true;
                this.textContent = 'Procesando...';

                const currentForm = document.getElementById('productForm'); // Re-seleccionar
                const url = currentForm.action;
                const formData = new FormData();
                const currentFormElements = currentForm.querySelectorAll('input, select, textarea');

                currentFormElements.forEach(element => {
                    if (element.id !== 'dynamicFileInput' && element.name) {
                        if (element.type === 'checkbox') {
                            formData.append(element.name, element.checked);
                        } else {
                            formData.append(element.name, element.value);
                        }
                    }
                });

                // Añadir imágenes NUEVAS (las que están en filesToUpload)
                const newImagesCount = filesToUpload.items.length;
                for (let i = 0; i < newImagesCount; i++) {
                    formData.append('archivosImagen', filesToUpload.items[i].getAsFile());
                }

                // (Validación de imagen para nuevos productos...)
                const isNewProduct = formData.get('id') === '';
                 if (isNewProduct && countTotalImages() === 0 && newImagesCount === 0) { // Chequear ambos
                      showAlert('Debe seleccionar al menos una imagen para el nuevo producto.', 'danger');
                      this.disabled = false;
                      this.textContent = /*[[${producto.id == null ? 'Registrar Producto' : 'Guardar Cambios'}]]*/ 'Guardar';
                      return;
                 }

                if (csrfParameterName && csrfToken) {
                    formData.append(csrfParameterName, csrfToken);
                }

                try {
                    const response = await fetch(url, { method: 'POST', body: formData });

                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        const html = await response.text();
                        document.documentElement.innerHTML = html; // Reemplaza TODO

                        // ¡Vuelve a llamar a la inicialización!
                        console.log("Re-inicializando listeners después de error...");
                        initializeProductForm();
                    }
                } catch (error) {
                    console.error('Error en fetch:', error);
                    showAlert('Error de conexión al guardar.', 'danger');
                     const currentSubmitBtn = document.getElementById('submitButton'); // Re-seleccionar
                     if(currentSubmitBtn) {
                         currentSubmitBtn.disabled = false;
                         currentSubmitBtn.textContent = /*[[${producto.id == null ? 'Registrar Producto' : 'Guardar Cambios'}]]*/ 'Guardar';
                     }
                }
            });

            // --- Inicialización (Carga inicial de tipos) ---
            const initialCategoryIdValue = selectCategoria.value;
            if (initialCategoryIdValue) {
                cargarTiposProducto(initialCategoryIdValue);
            } else {
                selectTipoProducto.disabled = true;
            }

            console.log("Listeners del formulario adjuntados.");

        } // --- Fin de initializeProductForm ---

        // --- Ejecutar la inicialización en la carga inicial ---
        document.addEventListener('DOMContentLoaded', initializeProductForm);

        /* ]]> */
    </script>
</div>
</body>
</html>

