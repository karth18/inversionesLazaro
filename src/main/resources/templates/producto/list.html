<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{master.html}">
<head>
    <meta charset="UTF-8"/>
    <title>Productos</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>
<body>
<div class="container py-4" layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestión de Productos</h2>
        <a class="btn btn-primary" th:href="@{/admin/productos/nuevo}">
            <i class="fas fa-plus-circle"></i> Nuevo producto
        </a>
    </div>

    <!-- Mensajes Flash -->
    <div th:if="${msgExito}" class="alert alert-success" th:text="${msgExito}"></div>
    <div th:if="${msgError}" class="alert alert-danger" th:text="${msgError}"></div>
    <div th:if="${msgAdvertencia}" class="alert alert-warning" th:text="${msgAdvertencia}"></div>

    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Código</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Imagen</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="p : ${productos}">
            <td th:text="${p.id}">1</td>

            <!-- CORRECCIÓN: Usamos 'codPro' según la entidad -->
            <td th:text="${p.codPro}">COD</td>
            <td th:text="${p.nomPro}">Nombre</td>

            <!-- Asumiendo que has cargado el objeto Marca o que tienes un helper para el nombre -->
            <td th:text="${p.idMarca != null} ? ${p.idMarca.nombre} : 'N/A'">Marca</td>

            <td>S/ <span th:text="${#numbers.formatDecimal(p.precio, 1, 2)}">0.00</span></td>
            <td th:text="${p.stock}">0</td>
            <td>
                <!-- Lógica para mostrar la imagen principal (asumimos que la lista es cargada) -->
                <th:block th:with="imagenPrincipal=${p.imagenes != null ? #lists.toList(p.imagenes).get(0) : null}">
                    <img th:if="${imagenPrincipal != null}"
                         th:src="@{'/uploads/' + ${imagenPrincipal.ruta}}"
                         alt="Imagen Principal"
                         style="height:60px; width:60px; object-fit:cover; border-radius: 4px;"/>
                    <span th:unless="${imagenPrincipal != null}">Sin Imagen</span>
                </th:block>
            </td>
            <td>
                <a th:href="@{|/admin/productos/editar/${p.id}|}" class="btn btn-sm btn-outline-primary">Editar</a>
                <form th:action="@{|/admin/productos/eliminar/${p.id}|}" method="post" style="display:inline" onsubmit="return confirm('¿Está seguro de eliminar este producto y TODAS sus imágenes? Esta acción es irreversible.');">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Paginación (si la usas) -->
    <!-- ... tu código de paginación ... -->

    <p><a th:href="@{/admin}" class="btn btn-secondary mt-3">Volver al panel</a></p>
</div>
</body>
</html>
