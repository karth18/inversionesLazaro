<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{master.html}">
<head>
    <meta charset="UTF-8"/>
    <title>Checkout - Envío y Pago</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .summary-card { position: sticky; top: 20px; }
        .address-card { border: 1px solid #ddd; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; }
        #changeAddressModal .list-group-item-action { display: flex; justify-content: space-between; align-items: center; }
        #changeAddressModal .address-content { flex-grow: 1; cursor: pointer; }
        #changeAddressModal .address-actions { flex-shrink: 0; }
        .summary-item-img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
        #giftMessageGenerator { background-color: #f8f9fa; border: 1px dashed #ced4da; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container py-5" layout:fragment="content">
    <h1 class="mb-4 text-center text-primary">Detalles de Envío y Pago</h1>

    <div id="alertContainer"></div>

    <div class="row g-4">
        <div class="col-lg-8">

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">1. Dirección de Envío</h2>
                    <button class="btn btn-outline-primary btn-sm" id="changeAddressBtn"
                            data-bs-toggle="modal" data-bs-target="#changeAddressModal"
                            th:disabled="${direccionesUsuario == null or #lists.isEmpty(direccionesUsuario)}">
                        Cambiar Dirección
                    </button>
                </div>
                <div class="card-body" id="selectedAddressDisplay">
                    <div th:if="${direccionSeleccionada != null}">
                        <p class="mb-1">
                            <strong><span th:if="${direccionSeleccionada.esPrincipal}">(Principal) </span></strong>
                            <span th:text="${direccionSeleccionada.calleAvenida} + ' ' + ${direccionSeleccionada.numeroCalle}"></span>
                        </p>
                        <p class="mb-1" th:text="${direccionSeleccionada.distrito} + ', ' + ${direccionSeleccionada.provincia} + ', ' + ${direccionSeleccionada.departamento}"></p>
                        <small th:if="${direccionSeleccionada.dptoInterior}" th:text="'Detalles: ' + ${direccionSeleccionada.dptoInterior}"></small>
                    </div>
                    <div th:if="${direccionSeleccionada == null}">
                        <div class="alert alert-warning" role="alert">
                            No tienes una dirección de envío.
                            <a href="#" data-bs-toggle="modal" data-bs-target="#newAddressModal">Agrega una aquí</a>.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="newAddressModal" tabindex="-1" aria-labelledby="newAddressModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="newAddressModalLabel">Agregar Nueva Dirección</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="newAddressForm">
                                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" id="direccionId" name="id">

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="departamentoSelect" class="form-label">Departamento <span class="text-danger">*</span></label>
                                        <select class="form-select" id="departamentoSelect" name="departamento.id" required>
                                            <option value="">-- Seleccione --</option>
                                            <option th:each="dep : ${departamentos}" th:value="${dep.id}" th:text="${dep.nombre}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="provinciaSelect" class="form-label">Provincia <span class="text-danger">*</span></label>
                                        <select class="form-select" id="provinciaSelect" name="provincia.id" required disabled>
                                            <option value="">-- Seleccione Departamento --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="distritoSelect" class="form-label">Distrito <span class="text-danger">*</span></label>
                                        <select class="form-select" id="distritoSelect" name="distrito.id" required disabled>
                                            <option value="">-- Seleccione Provincia --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <label for="calleAvenida" class="form-label">Avenida / Calle / Jirón <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="calleAvenida" name="calleAvenida" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="numeroCalle" class="form-label">Número <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="numeroCalle" name="numeroCalle" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="dptoInterior" class="form-label">Dpto./ Interior/ Piso (Opcional)</label>
                                        <input type="text" class="form-control" id="dptoInterior" name="dptoInterior">
                                    </div>
                                    <div class="col-12" id="esPrincipalWrapper">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="esPrincipalNew" name="esPrincipal">
                                            <label class="form-check-label" for="esPrincipalNew">Marcar como dirección principal</label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="saveNewAddressBtn">Guardar Dirección</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light"><h2 class="h5 mb-0">2. Método de Envío</h2></div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="shippingMethod" id="deliveryRadio" value="delivery" checked>
                        <label class="form-check-label" for="deliveryRadio">Despacho a Domicilio (Costo: S/ <span id="deliveryCost">10.00</span>)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="shippingMethod" id="pickupRadio" value="pickup">
                        <label class="form-check-label" for="pickupRadio">Retiro en Tienda (Gratis)</label>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm summary-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Resumen de tu Pedido</h5>

<!--                    <ul id="summaryItemList" class="list-group list-group-flush mb-3"-->
<!--                        th:if="${itemsCarrito != null and not #lists.isEmpty(itemsCarrito)}">-->

<!--                        <li th:each="item : ${itemsCarrito}"-->
<!--                            class="list-group-item d-flex justify-content-between align-items-center px-0">-->
<!--                            <div class="d-flex align-items-center">-->
<!--                                <img th:src="@{${item.imagenUrl}}" alt="" class="summary-item-img">-->
<!--                                <div>-->
<!--                                    <small class="d-block" th:text="${item.nombre}"></small>-->
<!--                                    <small class="text-muted" th:text="'Cant: ' + ${item.cantidad}"></small>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <span class="fw-semibold" th:text="'S/ ' + ${#numbers.formatDecimal(item.precioUnitario * item.cantidad, 1, 'COMMA', 2, 'POINT')}"></span>-->
<!--                        </li>-->
<!--                    </ul>-->

                    <hr th:if="${itemsCarrito != null and not #lists.isEmpty(itemsCarrito)}">

                    <div th:if="${totales != null}">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="summarySubtotal" th:text="${'S/ ' + #numbers.formatDecimal(totales.subtotal, 1, 'COMMA', 2, 'POINT')}">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Costo de Envío:</span>
                            <span id="summaryShippingCost">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Descuentos:</span>
                            <span id="summaryDiscount" th:text="${'-S/ ' + #numbers.formatDecimal(totales.ahorroPorProductos, 1, 'COMMA', 2, 'POINT')}">-S/ 0.00</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between fw-bold h5">
                            <span>Total a Pagar:</span>
                            <span id="summaryTotal" th:text="${'S/ ' + #numbers.formatDecimal(totales.total, 1, 'COMMA', 2, 'POINT')}">S/ 0.00</span>
                        </div>
                    </div>
                    <div th:if="${totales == null or #lists.isEmpty(itemsCarrito)}" class="alert alert-info small">
                        Tu carrito está vacío.
                    </div>

                    <button id="goToPaymentBtn" class="btn btn-primary w-100 mt-4"
                            th:disabled="${totales == null or #lists.isEmpty(itemsCarrito)}">
                        Ir a Pagar
                    </button>
                    <small id="paymentValidationMsg" class="d-block text-danger text-center mt-2" style="display: none !important;">
                        Selecciona o agrega una dirección para el envío.
                    </small>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="changeAddressModal" tabindex="-1" aria-labelledby="changeAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeAddressModalLabel">Selecciona una Dirección</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="addressListContainer">
                    </div>
                    <p id="noAddressMessage" class="text-muted" style="display: none;"
                       th:style="${direccionesUsuario == null or #lists.isEmpty(direccionesUsuario)} ? 'display: block;' : 'display: none;'">
                        No tienes direcciones guardadas.
                    </p>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="openNewAddressModalBtn">
                        <i class="fas fa-plus"></i> Agregar Nueva Dirección
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="selectAddressBtn">Seleccionar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Datos del Modelo (Inyectados por Thymeleaf)
        const itemsCarrito = /*[[${itemsCarrito}]]*/ [];
        let direccionSeleccionada = /*[[${direccionSeleccionada}]]*/ null; // Objeto Direccion o null (Mutable)
        let direccionesUsuario = /*[[${direccionesUsuario}]]*/ []; // Lista de Direccion (Mutable)
        const deliveryCost = 10.0;
        const csrfToken = /*[[${_csrf?.token}]]*/ null;
        const csrfHeader = /*[[${_csrf?.headerName}]]*/ null;

        // --- Funciones de Ayuda ---
        function formatCurrency(value) {
            const numericValue = parseFloat(value);
            if (isNaN(numericValue)) return 'S/ 0.00';
            return `S/ ${numericValue.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Headers para Fetch con CSRF
        function getFetchHeaders() {
            const headers = new Headers({
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            });
            if (csrfHeader && csrfToken) {
                headers.append(csrfHeader, csrfToken);
            }
            return headers;
        }


        document.addEventListener('DOMContentLoaded', function() {

            // --- INICIO: NUEVAS FUNCIONES DE CARGA ---

            /**
             * Carga las provincias (y devuelve una Promesa)
             */
            async function cargarProvincias(depId) {
                provSelect.disabled = true;
                distSelect.disabled = true;
                provSelect.innerHTML = '<option value="">Cargando...</option>';
                distSelect.innerHTML = '<option value="">-- Seleccione Provincia --</option>';

                if (!depId) {
                    provSelect.innerHTML = '<option value="">-- Seleccione Departamento --</option>';
                    return; // Termina la ejecución
                }

                try {
                    const response = await fetch(`/api/direccion/provincias/${depId}`);
                    if (!response.ok) throw new Error('Error al cargar provincias');
                    const provincias = await response.json();

                    provSelect.innerHTML = '<option value="">-- Seleccione Provincia --</option>';
                    provincias.forEach(p => {
                        provSelect.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
                    });
                    provSelect.disabled = false;
                } catch (error) {
                    console.error(error);
                    provSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
            }

            /**
             * Carga los distritos (y devuelve una Promesa)
             */
            async function cargarDistritos(provId) {
                distSelect.disabled = true;
                distSelect.innerHTML = '<option value="">Cargando...</option>';

                if (!provId) {
                    distSelect.innerHTML = '<option value="">-- Seleccione Provincia --</option>';
                    return; // Termina la ejecución
                }

                try {
                    const response = await fetch(`/api/direccion/distritos/${provId}`);
                    if (!response.ok) throw new Error('Error al cargar distritos');
                    const distritos = await response.json();

                    distSelect.innerHTML = '<option value="">-- Seleccione Distrito --</option>';
                    distritos.forEach(d => {
                        distSelect.innerHTML += `<option value="${d.id}">${d.nombre}</option>`;
                    });
                    distSelect.disabled = false;
                } catch (error) {
                    console.error(error);
                    distSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
            }

            // --- FIN: NUEVAS FUNCIONES DE CARGA ---

            // --- Elementos DOM (Resumen) ---
            const summarySubtotalEl = document.getElementById('summarySubtotal');
            const summaryShippingCostEl = document.getElementById('summaryShippingCost');
            const summaryDiscountEl = document.getElementById('summaryDiscount');
            const summaryTotalEl = document.getElementById('summaryTotal');
            const deliveryCostDisplay = document.getElementById('deliveryCost');

            // --- Elementos DOM (Envío y Pago) ---
            const deliveryRadio = document.getElementById('deliveryRadio');
            const pickupRadio = document.getElementById('pickupRadio');
            const goToPaymentBtn = document.getElementById('goToPaymentBtn');
            const paymentValidationMsg = document.getElementById('paymentValidationMsg');
            const selectedAddressDisplay = document.getElementById('selectedAddressDisplay');
            const changeAddressBtn = document.getElementById('changeAddressBtn');

            // --- Elementos DOM (Modales de Dirección) ---
            const newAddressModalEl = document.getElementById('newAddressModal');
            const newAddressModal = new bootstrap.Modal(newAddressModalEl);
            const newAddressModalLabel = document.getElementById('newAddressModalLabel');
            const changeAddressModalEl = document.getElementById('changeAddressModal');
            const changeAddressModal = new bootstrap.Modal(changeAddressModalEl);

            const saveNewAddressBtn = document.getElementById('saveNewAddressBtn');
            const selectAddressBtn = document.getElementById('selectAddressBtn');
            const openNewAddressModalBtn = document.getElementById('openNewAddressModalBtn');
            const newAddressForm = document.getElementById('newAddressForm');
            const addressListContainer = document.getElementById('addressListContainer');

            // --- Elementos DOM (Formulario Dirección) ---
            const formDireccionId = document.getElementById('direccionId');
            const depSelect = document.getElementById('departamentoSelect');
            const provSelect = document.getElementById('provinciaSelect');
            const distSelect = document.getElementById('distritoSelect');
            const calleInput = document.getElementById('calleAvenida');
            const numeroInput = document.getElementById('numeroCalle');
            const dptoInput = document.getElementById('dptoInterior');
            const principalCheckbox = document.getElementById('esPrincipalNew');


            let currentShippingMethod=deliveryRadio.checked? 'delivery' : 'pickup';
            let currentSelectedAddress = direccionSeleccionada; // Usar la variable mutable

            // --- INICIO: Cargar Selección Guardada (sessionStorage) ---
            let savedAddressId = sessionStorage.getItem('checkoutSelectedAddressId');
            if (savedAddressId) {
                savedAddressId = parseInt(savedAddressId, 10);
                const savedDir = direccionesUsuario.find(dir => dir.id === savedAddressId);
                if (savedDir) {
                    currentSelectedAddress = savedDir;
                    direccionSeleccionada = savedDir;
                }
            }
            // --- FIN: Cargar Selección Guardada ---


            // --- Lógica de Resumen de Pedido ---

            // Tomamos los totales del HTML (cargados por Thymeleaf) como base
            let initialSubtotal = parseFloat(summarySubtotalEl ? summarySubtotalEl.textContent.replace(/S\/\s*/, '').replace(',', '') : 0);
            let initialDiscount = parseFloat(summaryDiscountEl ? summaryDiscountEl.textContent.replace(/-S\/\s*/, '').replace(',', '') : 0);

            function updateSummary() {
                const subtotal = initialSubtotal;
                const discount = initialDiscount;
                const shippingCost = currentShippingMethod === 'delivery' ? deliveryCost : 0;
                const total = subtotal + shippingCost - discount;

                if(summaryShippingCostEl) summaryShippingCostEl.textContent = formatCurrency(shippingCost);
                if(summaryTotalEl) summaryTotalEl.textContent = formatCurrency(total);
                if(deliveryCostDisplay) deliveryCostDisplay.textContent = deliveryCost.toFixed(2);

                validatePaymentButton();
            }

            function validatePaymentButton() {
                 const isDisabled = (currentShippingMethod === 'delivery' && !currentSelectedAddress);
                 if (goToPaymentBtn) goToPaymentBtn.disabled = isDisabled;
                 if (paymentValidationMsg) paymentValidationMsg.style.display = isDisabled ? 'block' : 'none';
            }

            // --- Lógica de Gestión de Direcciones ---

            /**
             * Actualiza el card "1. Dirección de Envío" en la página principal.
             */
            function updateSelectedAddressUI(address) {
                 currentSelectedAddress = address; // Actualizar estado global
                 console.log("Dirección seleccionada actualizada:", address);
                 if (address) {
                     // Construir el HTML dinámicamente
                     // (Usa los campos de string: address.distrito)
                     let addressHTML = `<p class="mb-1"><strong>${address.esPrincipal ? '(Principal) ' : ''}</strong></p>
                                        <p>${address.calleAvenida || ''} ${address.numeroCalle || ''}</p>
                                        <p>${address.distrito || ''}, ${address.provincia || ''}, ${address.departamento || ''}</p>`;
                     if (address.dptoInterior) {
                        addressHTML += `<small>Detalles: ${address.dptoInterior}</small>`;
                     }
                     selectedAddressDisplay.innerHTML = addressHTML;
                     if (changeAddressBtn) {
                        changeAddressBtn.disabled = false;
                     }
                 } else {
                     selectedAddressDisplay.innerHTML = `<div class="alert alert-warning" role="alert">
                         No has seleccionado ninguna dirección de envío.
                         <a href="#" data-bs-toggle="modal" data-bs-target="#newAddressModal">Agrega una aquí</a>.
                         </div>`;
                     if (changeAddressBtn) {
                        changeAddressBtn.disabled = true;
                     }
                 }
                 validatePaymentButton();
            }

            /**
             * Puebla la lista de direcciones en el modal "Cambiar Dirección"
             */
            function updateChangeAddressModalList() {
                 if (!addressListContainer) return;

                 const noAddressMsg = document.getElementById('noAddressMessage');
                 addressListContainer.innerHTML = '';

                 if (direccionesUsuario.length === 0) {
                     if(noAddressMsg) noAddressMsg.style.display = 'block';
                 } else {
                     if(noAddressMsg) noAddressMsg.style.display = 'none';
                     direccionesUsuario.forEach(dir => {
                         const dirElement = document.createElement('div');
                         dirElement.className = 'list-group-item list-group-item-action';
                         // (Usa los campos de string: dir.distrito)
                         dirElement.innerHTML = `
                            <div class="address-content">
                                <input class="form-check-input me-2" type="radio" name="selectedAddressRadio" value="${dir.id}" ${currentSelectedAddress && dir.id === currentSelectedAddress.id ? 'checked' : ''}>
                                <strong>
                                    ${dir.esPrincipal ? '(Principal) ' : ''}
                                    ${dir.calleAvenida || ''} ${dir.numeroCalle || ''}
                                </strong><br>
                                <small>${dir.distrito || ''}, ${dir.provincia || ''}, ${dir.departamento || ''}</small>
                                ${dir.dptoInterior ? `<br><small>Detalles: ${dir.dptoInterior}</small>` : ''}
                            </div>
                            <div class="address-actions">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="handleEdit(${dir.id})"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="handleDelete(${dir.id})"><i class="fas fa-trash-alt"></i></button>
                            </div>
                         `;
                         dirElement.querySelector('.address-content').addEventListener('click', () => {
                            dirElement.querySelector('input[type="radio"]').checked = true;
                         });
                         addressListContainer.appendChild(dirElement);
                     });
                 }

                 if(changeAddressBtn){
                    changeAddressBtn.disabled = (direccionesUsuario.length === 0);
                 }
            }

            /**
             * Prepara el modal para "Agregar Nueva Dirección" (limpia el formulario)
             */
            function prepareNewAddressModal() {
                newAddressModalLabel.textContent = "Agregar Nueva Dirección";
                newAddressForm.reset();
                formDireccionId.value = '';

                const wrapper = document.getElementById('esPrincipalWrapper');
                const label = wrapper.querySelector('label');

                if (direccionesUsuario.length === 0) {
                    wrapper.style.display = 'none';
                } else {
                    wrapper.style.display = 'block';
                    label.textContent = '¿Quieres que esta sea tu nueva dirección principal?';
                }

                provSelect.innerHTML = '<option value="">-- Seleccione Departamento --</option>';
                distSelect.innerHTML = '<option value="">-- Seleccione Provincia --</option>';
                provSelect.disabled = true;
                distSelect.disabled = true;
                newAddressModal.show();
            }

            // --- Lógica de Selects Dinámicos (Ubigeo) ---
            depSelect.addEventListener('change', function() {
                cargarProvincias(this.value);
            });

            provSelect.addEventListener('change', function() {
                cargarDistritos(this.value);
            });


            /**
             * Función UNIFICADA para Guardar (POST) o Actualizar (PUT) una dirección
             */
            async function saveOrUpdateAddress() {
                if (!newAddressForm.checkValidity()) {
                     newAddressForm.classList.add('was-validated');
                     return;
                }
                newAddressForm.classList.remove('was-validated');

                const direccionId = formDireccionId.value;
                const isUpdating = !!direccionId;

                let esPrincipalValue;
                if (isUpdating) {
                    esPrincipalValue = principalCheckbox.checked;
                } else {
                    esPrincipalValue = (direccionesUsuario.length === 0) ? true : principalCheckbox.checked;
                }

                const addressData = {
                    id: isUpdating ? direccionId : null,
                    departamento: { id: depSelect.value },
                    provincia: { id: provSelect.value },
                    distrito: { id: distSelect.value },
                    calleAvenida:calleInput.value,
                    numeroCalle:numeroInput.value,
                    dptoInterior:dptoInput.value || null,
                    esPrincipal: esPrincipalValue
                };

                const url = isUpdating ? `/api/direccion/${direccionId}` : '/api/direccion/nueva';
                const method = isUpdating ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: getFetchHeaders(),
                        body: JSON.stringify(addressData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Error ${response.status}`);
                    }

                    const savedAddress = await response.json();

                    if (isUpdating) {
                        const index = direccionesUsuario.findIndex(d => d.id === savedAddress.id);
                        if (index !== -1) {
                            direccionesUsuario[index] = savedAddress;
                        }
                    } else {
                        direccionesUsuario.push(savedAddress);
                    }

                    if (savedAddress.esPrincipal || direccionesUsuario.length === 1) {
                        direccionesUsuario.forEach(d => {
                            if (d.id !== savedAddress.id) d.esPrincipal = false;
                        });
                        updateSelectedAddressUI(savedAddress);
                        sessionStorage.setItem('checkoutSelectedAddressId', savedAddress.id);
                    }

                    if (currentSelectedAddress && currentSelectedAddress.id === savedAddress.id) {
                         updateSelectedAddressUI(savedAddress);
                    }

                    updateChangeAddressModalList();
                    newAddressModal.hide();

                } catch (error) {
                    console.error('Error al guardar la dirección:', error);
                    alert(`No se pudo guardar la dirección: ${error.message}`);
                }
            }

            // --- Funciones Globales (para onclick) ---

            /**
             * Carga los datos de una dirección en el formulario para editarla
             * (*** VERSIÓN CORREGIDA ***)
             */
            window.handleEdit = async function(id) {
                console.log("Editando ID:", id);
                try {
                    const response = await fetch(`/api/direccion/${id}`, { headers: getFetchHeaders() });
                    if (!response.ok) throw new Error('No se pudo cargar la dirección');

                    // dir AHORA tiene: { id: ..., calleAvenida: ..., departamentoId: 15, provinciaId: 1501, distritoId: 150101 }
                    const dir = await response.json();

                    newAddressModalLabel.textContent = "Editar Dirección";
                    formDireccionId.value = dir.id;
                    calleInput.value = dir.calleAvenida;
                    numeroInput.value = dir.numeroCalle;
                    dptoInput.value = dir.dptoInterior;
                    principalCheckbox.checked = dir.esPrincipal;

                    // --- INICIO: LÓGICA ASÍNCRONA CORREGIDA CON IDs PLANOS ---

                    // 1. Asigna el departamento (sincrónico)
                    depSelect.value = dir.departamentoId;

                    // 2. ESPERA a que la función cargarProvincias TERMINE
                    await cargarProvincias(dir.departamentoId);

                    // 3. Asigna la provincia (sincrónico)
                    provSelect.value = dir.provinciaId;

                    // 4. ESPERA a que la función cargarDistritos TERMINE
                    await cargarDistritos(dir.provinciaId);

                    // 5. Asigna el distrito (sincrónico)
                    distSelect.value = dir.distritoId;

                    // --- FIN: LÓGICA ASÍNCRONA CORREGIDA ---

                    changeAddressModal.hide();
                    newAddressModal.show();

                } catch(error) {
                    console.error("Error al cargar dirección para editar:", error);
                    alert("Error: " + error.message);
                }
            }

            /**
             * Elimina una dirección
             */
            window.handleDelete = async function(id) {
                if (!confirm("¿Estás seguro de que deseas eliminar esta dirección?")) {
                    return;
                }

                try {
                    const response = await fetch(`/api/direccion/${id}`, {
                        method: 'DELETE',
                        headers: getFetchHeaders()
                    });

                    if (!response.ok) {
                         throw new Error('No se pudo eliminar la dirección');
                    }

                    direccionesUsuario = direccionesUsuario.filter(d => d.id !== id);
                    updateChangeAddressModalList();

                    if (currentSelectedAddress && currentSelectedAddress.id === id) {
                        sessionStorage.removeItem('checkoutSelectedAddressId');

                        const newSelected = direccionesUsuario.find(d => d.esPrincipal) || direccionesUsuario[0] || null;
                        updateSelectedAddressUI(newSelected);

                        if (newSelected) {
                            sessionStorage.setItem('checkoutSelectedAddressId', newSelected.id);
                        }
                    }

                    alert("Dirección eliminada correctamente.");

                } catch(error) {
                    console.error("Error al eliminar dirección:", error);
                    alert("Error: " + error.message);
                }
            }


            // --- Event Listeners ---

            deliveryRadio.addEventListener('change', () => {
                if (deliveryRadio.checked) {
                    currentShippingMethod = 'delivery';
                    updateSummary();
                }
            });
            pickupRadio.addEventListener('change', () => {
                 if (pickupRadio.checked) {
                    currentShippingMethod = 'pickup';
                    updateSummary();
                }
            });

            if(saveNewAddressBtn) saveNewAddressBtn.addEventListener('click', saveOrUpdateAddress);

            if(openNewAddressModalBtn) openNewAddressModalBtn.addEventListener('click', () => {
                changeAddressModal.hide();
                prepareNewAddressModal();
            });

            if(selectAddressBtn) selectAddressBtn.addEventListener('click', () => {
                const selectedRadio = changeAddressModalEl.querySelector('input[name="selectedAddressRadio"]:checked');
                if (selectedRadio) {
                    const selectedId = parseInt(selectedRadio.value, 10);
                    const selectedDir = direccionesUsuario.find(dir => dir.id === selectedId);
                    if (selectedDir) {
                        updateSelectedAddressUI(selectedDir);
                        sessionStorage.setItem('checkoutSelectedAddressId', selectedDir.id);
                    }
                    changeAddressModal.hide();
                } else {
                    alert("Por favor, selecciona una dirección.");
                }
            });

            // --- Inicialización ---
            if (currentSelectedAddress) {
                updateSelectedAddressUI(currentSelectedAddress);
            }

            updateChangeAddressModalList();
            updateSummary();
        });
        /*]]>*/
    </script>
</div>
</body>
</html>